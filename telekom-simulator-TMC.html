<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Telekom Simulator - TMC Sauerland</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --magenta: #E20074;
            --magenta-dark: #B3005C;
            --magenta-light: #FF1493;
            --magenta-glow: rgba(226, 0, 116, 0.6);
            --dark-bg: #08080C;
            --dark-card: #1A1A24;
            --accent-cyan: #00D4FF;
            --accent-gold: #FFD700;
            --accent-green: #00FF88;
            --accent-red: #FF4757;
            --text-white: #FFFFFF;
            --text-gray: #8888AA;
            --text-light: #CCCCDD;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100%; overflow: hidden; touch-action: none; }
        body { font-family: 'Outfit', sans-serif; background: var(--dark-bg); color: var(--text-white); position: fixed; inset: 0; }

        .screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; }
        .screen.active { display: flex; }

        #intro { background: linear-gradient(160deg, #08080C 0%, #1a0a14 50%, #08080C 100%); }
        .intro-scene { display: none; flex-direction: column; align-items: center; text-align: center; max-width: 420px; width: 100%; }
        .intro-scene.active { display: flex; }

        .char-wrap { margin-bottom: 1rem; }
        .char-canvas { width: 130px; height: 175px; }

        .bubble { background: var(--dark-card); border: 2px solid var(--magenta); border-radius: 18px; padding: 1.1rem 1.4rem; position: relative; box-shadow: 0 0 40px var(--magenta-glow); }
        .bubble::before { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-bottom-color: var(--magenta); }
        .bubble p { font-size: 0.95rem; line-height: 1.55; color: var(--text-light); }
        .bubble .hi { color: var(--magenta-light); font-weight: 700; }
        .bubble .cy { color: var(--accent-cyan); font-weight: 700; }
        .bubble .go { color: var(--accent-gold); font-weight: 700; }

        .char-name { margin-top: 0.9rem; font-size: 0.95rem; font-weight: 700; }
        .char-name.veter { color: var(--accent-cyan); }
        .char-name.tmc { color: var(--magenta-light); }

        .tmc-badge { width: 85px; height: 85px; border-radius: 50%; background: linear-gradient(145deg, var(--magenta), var(--magenta-dark)); display: flex; align-items: center; justify-content: center; font-size: 2.8rem; font-weight: 900; color: white; box-shadow: 0 0 50px var(--magenta-glow); margin-bottom: 0.8rem; }

        .btn { padding: 0.85rem 2.2rem; font-family: 'Outfit', sans-serif; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; border: none; border-radius: 50px; cursor: pointer; }
        .btn-primary { background: linear-gradient(145deg, var(--magenta), var(--magenta-dark)); color: white; box-shadow: 0 8px 30px var(--magenta-glow); margin-top: 1.2rem; }
        .btn-secondary { background: var(--dark-card); color: var(--text-light); border: 1px solid rgba(255,255,255,0.12); margin-top: 0.6rem; }

        #menu { background: linear-gradient(160deg, #08080C 0%, #1a0a14 50%, #08080C 100%); }
        .menu-bg { position: absolute; inset: 0; background: radial-gradient(ellipse at 30% 20%, var(--magenta-glow) 0%, transparent 50%); pointer-events: none; }
        .menu-content { display: flex; flex-direction: column; align-items: center; z-index: 2; }
        .logo-t { font-size: 4.5rem; font-weight: 900; color: var(--magenta); text-shadow: 0 0 50px var(--magenta-glow); }
        .title { font-size: 1.9rem; font-weight: 900; background: linear-gradient(135deg, #fff, var(--magenta-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 0.7rem; color: var(--text-gray); letter-spacing: 0.35em; margin-bottom: 1rem; }

        .stats-row { display: flex; gap: 0.8rem; margin-bottom: 1.2rem; }
        .stat { background: var(--dark-card); border-radius: 14px; padding: 0.6rem 0.9rem; text-align: center; min-width: 70px; }
        .stat-icon { font-size: 1.2rem; }
        .stat-val { font-size: 1.15rem; font-weight: 800; }
        .stat-lbl { font-size: 0.5rem; color: var(--text-gray); }

        .menu-btns { display: flex; flex-direction: column; width: 100%; max-width: 260px; gap: 0.5rem; }

        .sound-btn { position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .sound-btn svg { width: 18px; height: 18px; fill: white; }
        .sound-btn.muted .on { display: none; }
        .sound-btn:not(.muted) .off { display: none; }

        #game { padding: 0; }
        #game-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }

        .hud { position: absolute; top: 0; left: 0; right: 0; padding: 0.5rem 0.7rem; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, transparent 100%); z-index: 10; }
        .hud-left { display: flex; gap: 0.7rem; }
        .hud-val { font-size: 0.95rem; font-weight: 800; }
        .hud-val.score { color: var(--magenta-light); }
        .hud-val.phones { color: var(--accent-cyan); }
        .hud-val.sims { color: var(--accent-gold); }
        .hud-val.lives { color: var(--accent-red); }

        .hud-right { display: flex; gap: 0.35rem; }
        .hud-btn { width: 34px; height: 34px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .hud-btn svg { width: 15px; height: 15px; fill: white; }
        .pause-icon { display: flex; gap: 2px; }
        .pause-icon span { width: 3px; height: 11px; background: white; }

        .level-badge { position: absolute; top: 48px; left: 50%; transform: translateX(-50%); background: var(--dark-card); padding: 0.25rem 0.7rem; border-radius: 12px; border: 1px solid var(--magenta); font-size: 0.6rem; font-weight: 700; color: var(--magenta-light); z-index: 10; }

        .notif { position: absolute; top: 78px; left: 50%; transform: translateX(-50%) scale(0); padding: 0.4rem 0.9rem; border-radius: 10px; font-size: 0.9rem; font-weight: 800; z-index: 10; transition: transform 0.2s; white-space: nowrap; }
        .notif.show { transform: translateX(-50%) scale(1); }
        .notif.combo { background: rgba(255,215,0,0.15); border: 2px solid var(--accent-gold); color: var(--accent-gold); }
        .notif.power { background: rgba(0,255,136,0.15); border: 2px solid var(--accent-green); color: var(--accent-green); }
        .notif.lvl { background: rgba(0,212,255,0.15); border: 2px solid var(--accent-cyan); color: var(--accent-cyan); }
        .notif.warn { background: rgba(255,71,87,0.15); border: 2px solid var(--accent-red); color: var(--accent-red); }

        .power-bar { position: absolute; top: 48px; right: 8px; background: var(--dark-card); border-radius: 10px; padding: 0.35rem 0.55rem; display: none; align-items: center; gap: 0.35rem; z-index: 10; border: 1px solid var(--accent-green); font-size: 0.75rem; font-weight: 700; color: var(--accent-green); }
        .power-bar.active { display: flex; }

        .veter-popup { position: absolute; top: 100px; left: -330px; width: 250px; background: rgba(20, 20, 32, 0.98); border: 3px solid var(--accent-cyan); border-radius: 16px; padding: 0.8rem 1rem; z-index: 25; transition: left 0.3s, right 0.3s; box-shadow: 0 0 40px rgba(0, 212, 255, 0.5); }
        .veter-popup.show { left: 10px; }
        .veter-popup.right { left: auto; right: -330px; }
        .veter-popup.right.show { right: 10px; left: auto; }
        .veter-popup-head { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.4rem; }
        .veter-popup-avatar { font-size: 1.6rem; }
        .veter-popup-name { font-size: 0.7rem; color: var(--accent-cyan); font-weight: 700; }
        .veter-popup-text { font-size: 1rem; color: var(--text-white); line-height: 1.4; font-weight: 500; }

        /* MULTITOUCH CONTROLS */
        .controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem 0.5rem 1.4rem; display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none; z-index: 10; }
        .ctrl-grp { display: flex; gap: 1rem; pointer-events: auto; }
        .ctrl { width: 78px; height: 78px; background: rgba(255,255,255,0.15); border: 3px solid rgba(255,255,255,0.35); border-radius: 22px; display: flex; align-items: center; justify-content: center; }
        .ctrl.active { background: var(--magenta) !important; border-color: #fff !important; }
        .ctrl svg { width: 34px; height: 34px; fill: white; pointer-events: none; }
        .ctrl.jump { width: 100px; height: 100px; border-radius: 50%; }
        .ctrl.jump svg { width: 46px; height: 46px; }

        .overlay { position: fixed; inset: 0; background: rgba(8, 8, 12, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
        .overlay.active { display: flex; }
        .ov-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 0.8rem; }
        .ov-title.pause { color: var(--accent-cyan); }
        .ov-title.over { color: var(--magenta); }

        .final-score { font-size: 3rem; font-weight: 900; }
        .final-lbl { font-size: 0.7rem; color: var(--text-gray); margin-bottom: 0.6rem; }
        .final-stats { display: flex; gap: 1rem; margin-bottom: 0.8rem; }
        .f-stat-icon { font-size: 1.1rem; }
        .f-stat-val { font-size: 1.1rem; font-weight: 700; }

        .achieve { background: rgba(255,215,0,0.1); border: 1px solid var(--accent-gold); border-radius: 12px; padding: 0.5rem 1rem; margin-bottom: 0.8rem; display: none; align-items: center; gap: 0.5rem; font-weight: 700; color: var(--accent-gold); }
        .achieve.show { display: flex; }

        .veter-box { background: var(--dark-card); border-radius: 12px; padding: 0.7rem 1rem; margin-bottom: 0.8rem; max-width: 300px; text-align: center; }
        .veter-lbl { font-size: 0.55rem; color: var(--accent-cyan); margin-bottom: 0.25rem; }
        .veter-txt { font-size: 0.85rem; color: var(--text-light); font-style: italic; }

        .ov-btns { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; max-width: 240px; }

        @media (max-width: 380px) {
            .ctrl { width: 68px; height: 68px; }
            .ctrl.jump { width: 90px; height: 90px; }
            .veter-popup { width: 210px; }
            .veter-popup-text { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <!-- ===== INTRO ===== -->
    <div class="screen active" id="intro">
        <!-- Scene 1 - Veter hat Online bestellt -->
        <div class="intro-scene active" id="s1">
            <div class="char-wrap">
                <canvas id="vc1" class="char-canvas" width="130" height="175"></canvas>
            </div>
            <div class="bubble">
                <p>
                    <strong>Ach du meine G√ºte!</strong> üò∞<br><br>
                    Junger Mann, ich bin <span class="cy">Veter Pogel</span>, 68 Jahre jung!<br><br>
                    Ich habe im <span class="hi">Telekom Online-Shop</span> bestellt und der Paketbote hat <span class="go">ALLES</span> auf der Stra√üe verloren! √úberall liegen meine neuen <span class="cy">Handys</span> und <span class="go">SIM-Karten</span>!
                </p>
            </div>
            <p class="char-name veter">üë¥ Veter Pogel, 68</p>
            <button class="btn btn-primary" onclick="nextScene()">Oh nein! ‚Üí</button>
        </div>

        <!-- Scene 2 -->
        <div class="intro-scene" id="s2">
            <div class="char-wrap">
                <canvas id="vc2" class="char-canvas" width="130" height="175"></canvas>
            </div>
            <div class="bubble">
                <p>
                    Ich wollte doch meinen Enkeln neue Handys schenken! üì±üéÅ<br><br>
                    In meinem Alter kann ich nicht mehr so schnell rennen... mein R√ºcken, wei√üt du! ü¶¥<br><br>
                    Aber ich hab geh√∂rt, die <span class="hi">Telekom</span> hat so einen <span class="cy">Superhelden</span>... wie hie√ü der nochmal?
                </p>
            </div>
            <p class="char-name veter">üë¥ Veter Pogel, 68</p>
            <button class="btn btn-primary" onclick="nextScene()">Erz√§hl mehr! ‚Üí</button>
        </div>

        <!-- Scene 3 - TMC entrance -->
        <div class="intro-scene" id="s3">
            <div class="tmc-badge">T</div>
            <div class="bubble">
                <p>
                    <span class="hi">KEINE SORGE, HERR POGEL!</span> üí™üòé<br><br>
                    Ich bin <span class="hi">TMC</span> - der <span class="cy">Telekom Mobile Champion</span>!<br><br>
                    Ihre Bestellung wird gerettet! Schneller als 5G, st√§rker als jedes Funkloch!<br>
                    <span class="go">Erleben was verbindet!</span> üöÄ
                </p>
            </div>
            <p class="char-name tmc">ü¶∏ TMC - Der Held</p>
            <button class="btn btn-primary" onclick="nextScene()">Wow! ‚Üí</button>
        </div>

        <!-- Scene 4 - Veter happy -->
        <div class="intro-scene" id="s4">
            <div class="char-wrap">
                <canvas id="vc3" class="char-canvas" width="130" height="175"></canvas>
            </div>
            <div class="bubble">
                <p>
                    <span class="go">Wunderbar!</span> Das ist ja ein <span class="hi">Service</span>! üéâ<br><br>
                    Aber Vorsicht vor den <span class="hi">b√∂sen Router-St√∂rern</span>! Die klauen Signal und machen nur √Ñrger! üì°‚ùå<br><br>
                    Ich schau zu und geb dir <span class="cy">Tipps</span>! Bin ja schlie√ülich seit 40 Jahren Telekom-Kunde! üòÑ
                </p>
            </div>
            <p class="char-name veter">üë¥ Veter Pogel, Kunde seit 1985</p>
            <button class="btn btn-primary" onclick="startFromIntro()">üéÆ Los geht's!</button>
        </div>
    </div>

    <!-- ===== MENU ===== -->
    <div class="screen" id="menu">
        <div class="menu-bg"></div>
        
        <button class="sound-btn" id="snd-menu">
            <svg class="on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            <svg class="off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
        </button>

        <div class="menu-content">
            <div class="logo-wrap">
                <div class="logo-glow"></div>
                <div class="logo-t">T</div>
                <div class="logo-dots">
                    <span class="logo-dot"></span>
                    <span class="logo-dot"></span>
                    <span class="logo-dot"></span>
                    <span class="logo-dot"></span>
                    <span class="logo-dot"></span>
                </div>
            </div>

            <h1 class="title">Telekom Simulator</h1>
            <p class="subtitle">Das Abenteuer</p>

            <div class="stats-row">
                <div class="stat">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-val" id="m-hs">0</div>
                    <div class="stat-lbl">Highscore</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">üì±</div>
                    <div class="stat-val" id="m-ph">0</div>
                    <div class="stat-lbl">Handys</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-val" id="m-lvl">1</div>
                    <div class="stat-lbl">Max Level</div>
                </div>
            </div>

            <div class="menu-btns">
                <button class="btn btn-primary" id="btn-play">üéÆ Spielen</button>
                <button class="btn btn-secondary" id="btn-story">üì∫ Story</button>
                <button class="btn btn-secondary" id="btn-help">‚ùì Hilfe</button>
            </div>
        </div>
    </div>

    <!-- ===== GAME ===== -->
    <div class="screen" id="game">
        <canvas id="game-canvas"></canvas>

        <div class="hud">
            <div class="hud-left">
                <div class="hud-item">
                    <div class="hud-lbl">Score</div>
                    <div class="hud-val score" id="h-score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-lbl">üì±</div>
                    <div class="hud-val phones" id="h-phones">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-lbl">üí≥</div>
                    <div class="hud-val sims" id="h-sims">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-lbl">‚ù§Ô∏è</div>
                    <div class="hud-val lives" id="h-lives">3</div>
                </div>
            </div>
            <div class="hud-right">
                <button class="hud-btn" id="snd-game">
                    <svg class="on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                    <svg class="off" viewBox="0 0 24 24" style="display:none"><path d="M4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                </button>
                <button class="hud-btn" id="btn-pause">
                    <div class="pause-icon"><span></span><span></span></div>
                </button>
            </div>
        </div>

        <div class="level-badge" id="lvl-badge">Level 1 - Neustadt</div>
        <div class="notif" id="notif"></div>
        <div class="power-bar" id="pwr-bar"><span id="pwr-icon">‚ö°</span><span id="pwr-time">5s</span></div>

        <!-- VETER POPUP f√ºr Live-Kommentare! -->
        <div class="veter-popup" id="veter-pop">
            <div class="veter-popup-head">
                <span class="veter-popup-avatar">üë¥</span>
                <span class="veter-popup-name">Veter Pogel</span>
            </div>
            <div class="veter-popup-text" id="veter-pop-txt">Super gemacht!</div>
        </div>

        <div class="controls">
            <div class="ctrl-grp">
                <button class="ctrl" id="c-left"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
                <button class="ctrl" id="c-right"><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
            </div>
            <div class="ctrl-grp">
                <button class="ctrl jump" id="c-jump"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
            </div>
        </div>
    </div>

    <!-- ===== PAUSE ===== -->
    <div class="overlay" id="ov-pause">
        <h2 class="ov-title pause">‚è∏Ô∏è Pause</h2>
        <div class="veter-box">
            <div class="veter-lbl">üë¥ Veter Pogel sagt:</div>
            <div class="veter-txt" id="pause-tip">Mach mal kurz Pause!</div>
        </div>
        <div class="ov-btns">
            <button class="btn btn-primary" id="btn-resume">‚ñ∂Ô∏è Weiter</button>
            <button class="btn btn-secondary" id="btn-quit">üè† Beenden</button>
        </div>
    </div>

    <!-- ===== GAME OVER ===== -->
    <div class="overlay" id="ov-over">
        <h2 class="ov-title over">üí• Game Over</h2>
        <div class="final-score" id="f-score">0</div>
        <div class="final-lbl">Punkte</div>
        <div class="final-stats">
            <div class="f-stat"><div class="f-stat-icon">üì±</div><div class="f-stat-val" id="f-phones">0</div></div>
            <div class="f-stat"><div class="f-stat-icon">üí≥</div><div class="f-stat-val" id="f-sims">0</div></div>
            <div class="f-stat"><div class="f-stat-icon">‚ö°</div><div class="f-stat-val" id="f-pwr">0</div></div>
            <div class="f-stat"><div class="f-stat-icon">üî•</div><div class="f-stat-val" id="f-combo">0</div></div>
        </div>
        <div class="achieve" id="achieve"><span id="ach-icon">üèÜ</span><span id="ach-txt">Neuer Highscore!</span></div>
        <div class="veter-box">
            <div class="veter-lbl">üë¥ Veter Pogel sagt:</div>
            <div class="veter-txt" id="veter-say">Danke f√ºr deine Hilfe!</div>
        </div>
        <div class="ov-btns">
            <button class="btn btn-primary" id="btn-retry">üîÑ Nochmal</button>
            <button class="btn btn-secondary" id="btn-menu">üè† Men√º</button>
        </div>
    </div>

    <script>
        // ===== AUDIO =====
        class Audio {
            constructor() { this.ctx = null; this.gain = null; this.muted = false; this.ok = false; this.loop = null; }
            init() { if (this.ok) return; try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.gain = this.ctx.createGain(); this.gain.connect(this.ctx.destination); this.gain.gain.value = 0.35; this.ok = true; } catch(e) {} }
            resume() { if (this.ctx?.state === 'suspended') this.ctx.resume(); }
            toggle() { this.muted = !this.muted; if (this.gain) this.gain.gain.value = this.muted ? 0 : 0.35; return this.muted; }
            note(f, d, t = 'sine', v = 0.12, dl = 0) { if (!this.ok) return; const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = t; o.frequency.value = f; const s = this.ctx.currentTime + dl; g.gain.setValueAtTime(0, s); g.gain.linearRampToValueAtTime(v, s + 0.012); g.gain.exponentialRampToValueAtTime(0.001, s + d); o.connect(g); g.connect(this.gain); o.start(s); o.stop(s + d + 0.01); }
            kick(t) { if (!this.ok) return; const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.frequency.setValueAtTime(140, t); o.frequency.exponentialRampToValueAtTime(35, t + 0.08); g.gain.setValueAtTime(0.3, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.1); o.connect(g); g.connect(this.gain); o.start(t); o.stop(t + 0.1); }
            hat(t) { if (!this.ok) return; const buf = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.03, this.ctx.sampleRate), d = buf.getChannelData(0); for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1; const n = this.ctx.createBufferSource(), g = this.ctx.createGain(), f = this.ctx.createBiquadFilter(); n.buffer = buf; f.type = 'highpass'; f.frequency.value = 9000; g.gain.setValueAtTime(0.07, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.03); n.connect(f); f.connect(g); g.connect(this.gain); n.start(t); }
            music() { if (!this.ok || this.loop) return; const bpm = 128, bt = 60/bpm, bass = [82.41, 82.41, 98, 82.41, 110, 82.41, 98, 123.47], arp = [329.63, 392, 493.88, 659.26, 493.88, 392]; let b = 0; const tick = () => { if (!this.loop) return; const now = this.ctx.currentTime; if (b % 4 === 0 || b % 4 === 2) this.kick(now); this.hat(now); this.note(bass[b % 8], bt * 0.7, 'sawtooth', 0.1); if (b % 2 === 1) this.note(arp[(b >> 1) % 6], bt * 0.2, 'square', 0.04); b++; }; tick(); this.loop = setInterval(tick, bt * 1000); }
            stop() { if (this.loop) { clearInterval(this.loop); this.loop = null; } }
            jump() { this.note(350, 0.07); this.note(480, 0.08, 'sine', 0.1, 0.03); }
            phone() { this.note(523, 0.07); this.note(659, 0.07, 'sine', 0.1, 0.05); this.note(784, 0.1, 'sine', 0.08, 0.1); }
            sim() { this.note(698, 0.06, 'triangle', 0.08); this.note(880, 0.08, 'triangle', 0.08, 0.05); }
            power() { [400,500,600,700,800].forEach((f,i) => this.note(f, 0.08, 'square', 0.06, i*0.04)); }
            combo() { this.note(523, 0.05, 'square', 0.08); this.note(659, 0.05, 'square', 0.08, 0.04); this.note(784, 0.05, 'square', 0.08, 0.08); }
            hurt() { this.note(180, 0.12, 'sawtooth', 0.12); this.note(140, 0.15, 'sawtooth', 0.1, 0.08); }
            die() { [380,330,280,230,170].forEach((f,i) => this.note(f, 0.15, 'sawtooth', 0.1, i*0.1)); }
            lvlup() { [523,587,659,784,880,1047].forEach((f,i) => this.note(f, 0.1, 'sine', 0.08, i*0.06)); }
            life() { [659,784,880,1047,1175].forEach((f,i) => this.note(f, 0.08, 'sine', 0.1, i*0.07)); }
        }
        const sfx = new Audio();

        const MAGENTA = '#E20074', MAGENTA_DARK = '#B3005C', MAGENTA_LIGHT = '#FF1493';
        const CYAN = '#00D4FF', GOLD = '#FFD700', GREEN = '#00FF88', RED = '#FF4757';

        const LEVELS = [
            { name: 'Neustadt', target: 400, bg: '#08080C', grav: 0.48, speed: 4.5, gap: 0.7, obs: 0.25, color: MAGENTA },
            { name: 'City Center', target: 1000, bg: '#0a0a14', grav: 0.5, speed: 5, gap: 0.85, obs: 0.35, color: '#0066CC' },
            { name: 'Tech Park', target: 2000, bg: '#0a100a', grav: 0.52, speed: 5.5, gap: 1, obs: 0.45, color: '#00AA66' },
            { name: 'Magenta Tower', target: 3500, bg: '#100a0a', grav: 0.54, speed: 6, gap: 1.1, obs: 0.55, color: MAGENTA_DARK },
            { name: 'Cloud Zone', target: 5500, bg: '#080814', grav: 0.56, speed: 6.5, gap: 1.2, obs: 0.65, color: '#6644AA' },
            { name: '5G Endzone', target: 99999, bg: '#0c0808', grav: 0.58, speed: 7.5, gap: 1.35, obs: 0.75, color: GOLD }
        ];

        // ===== MEGA FLACHWITZE - DIE BESTEN! =====
        const VETER_JOKES = [
            // SMARTPHONE KLASSIKER
            "Mein Smartphone ist wie ich: Alt, langsam, und braucht alle 3 Stunden Strom! üîã",
            "Ich hab mein Handy auf lautlos gestellt. Jetzt schreit es mich leise an.",
            "Fragt mein Enkel: 'Opa, was ist ein W√§hlton?' Ich so: 'Das Ger√§usch der Zivilisation!' ‚òéÔ∏è",
            "Mein Handy hat Face-ID. Es erkennt mich nur noch nach dem Mittagsschlaf! üò¥",
            "Ich wische auf meinem Handy. Es wischt zur√ºck. Wir verstehen uns nicht.",
            "Mein Akku h√§lt genau so lange wie meine Geduld - nicht sehr lange! ü™´",
            "Fr√ºher haben wir telefoniert um zu reden. Heute reden wir um zu telefonieren!",
            "Mein Smartphone hat 128GB. Ich hab 68 Jahre. Wer ist hier voller? ü§î",
            "Ich hab 47 Apps. Benutze 3. Wie bei meinen Hemden im Schrank!",
            "Mein Handy vibriert. Entweder Nachricht oder mein Herzschrittmacher! üíì",
            "Warum hei√üt es Smartphone? Meins ist schlauer als ich!",
            "Mein Sohn sagt: 'Papa, leg mal das Handy weg!' HA! Rache ist s√º√ü! üòà",
            
            // TELEKOM & INTERNET
            "Telekom-Hotline: 'Haben Sie neugestartet?' - 'Ja, mein ganzes Leben!' üìû",
            "Mein WLAN-Passwort ist 'BringMirEinBier' - Die Enkel tippen es gerne ein! üç∫",
            "Router blinkt rot. Ich blinke auch rot. Wir sind ein Team!",
            "Der Techniker sagt 'Ping ist gut!' Ich dachte wir spielen nicht Tischtennis? üèì",
            "Mein Internet ist so langsam, ich kann den Daten beim Wandern zuschauen! üêå",
            "5G? Ich w√§re schon mit 1G zufrieden - 1 Gutes Netz!",
            "Funkloch bei mir zuhause? Nein, Funkkrater! üï≥Ô∏è",
            "Magenta ist meine Lieblingsfarbe! Zahle ja auch genug daf√ºr...",
            "Streaming ruckelt. Wie ich morgens aus dem Bett! üõèÔ∏è",
            "'Erleben was verbindet' - Haupts√§chlich Warteschleifen-Musik!",
            
            // OPA VS TECHNIK
            "Mein Enkel zeigt mir TikTok. Ich zeig ihm wie man Kartoffeln sch√§lt. 1:1! ü•î",
            "Ich hab eine Smart-Watch. Sie sagt ich soll mich bewegen. Frech! ‚åö",
            "Fr√ºher hatten Telefone Schn√ºre. Die konnten nicht weglaufen!",
            "Sprachnachricht aufnehmen? *r√§usper* 'TEST TEST HALLO?' ...gesendet. üé§",
            "Mein Enkel lacht √ºber mein Handy. Es ist 3 Jahre alt. Wie sein Hamster!",
            "Ich fotografiere meinen Fernseher und schick's per WhatsApp. Modern! üì∫",
            "Google sagt ich hab 3 Krankheiten. Mein Arzt sagt: 'Geh offline!' üè•",
            "Videoanruf mit der Familie. Alle sehen meine Nasenhaare. Toll. üëÉ",
            "QR-Code scannen? Ich dachte das sind Labyrinthe f√ºr Ameisen!",
            "Mein Enkel: 'Opa, dein Handy klingelt!' Ich: 'HALLO??' ans B√ºgeleisen üòÖ",
            
            // SMARTPHONE-FAILS
            "Hab ausversehen 47 Fotos von meinem Daumen gemacht. Ist jetzt ein Album. üëç",
            "Siri fragt was ich will. ICH WILL DASS DU MICH VERSTEHST! üò§",
            "Meine Frau per Sprachnachricht: 30 Sekunden Atmen, dann 'Tsch√ºss!'",
            "Emoji-Tastatur entdeckt! Jetzt rede ich nur noch in Bildchen! üé≠üé™üé†",
            "Autokorrektur macht aus 'Gr√º√üe' immer 'Gr√∂√üe'. Bin aber nur 1,72m!",
            "Hab WhatsApp-Status ge√§ndert. Niemand hat's gemerkt. Wie immer. üò¢",
            "Diktierfunktion: 'Ruf Ingrid an!' Handy ruft Indien an. Namaste! üáÆüá≥",
            "Selfie mit Blitz. Netzhaut verbrannt. Aber 3 Likes bekommen! Worth it! üì∏",
            "Push-Nachrichten ausgestellt. Endlich Ruhe! ...Warte, was hab ich verpasst?",
            "Bildschirmzeit: 4 Stunden. Davon 3,5 Stunden Wetter-App anstarren. ‚òÄÔ∏è",
            
            // GENERATIONSKONFLIKT
            "Mein Enkel tippt mit 2 Daumen. Ich brauche 2 H√§nde und eine Brille! üîç",
            "Kinder heute wischen auf B√ºchern. Die sind kaputt, nicht die B√ºcher!",
            "Fr√ºher war WhatsApp ein Postbote der 2x am Tag kam!",
            "Cloud-Speicher? Meine Wolken speichern nur Regen! ‚õàÔ∏è",
            "Mein Passwort: Geburtstag meiner Frau. Sie wei√ü es nicht. ICH auch nicht!",
            "Hab versehentlich Urlaub gebucht. Beim Wetter nachschauen. Mallorca soll sch√∂n sein!",
            "Enkel erkl√§rt Instagram. Nach 20 Minuten verstehe ich: Alle haben Hunger. üçï",
            "Telefon klingelt, ich schreie 'JA BITTE?' - War nur der Wecker. üò¨",
            "Mein WLAN hei√üt 'Oma klick hier' - Klappt trotzdem nie!",
            "Tablets hie√üen fr√ºher Schiefertafeln. Da war wenigstens der Akku nie leer!",
            
            // ABSOLUTE KNALLER
            "Flugmodus an. Handy fliegt nicht. Will mein Geld zur√ºck! ‚úàÔ∏è",
            "Bluetooth verbunden! Mit was? Mit wem? Wohin? HILFE! üÜò",
            "Habe 'In der N√§he teilen' gedr√ºckt. Jetzt hat Nachbar meine Fotos. üò±",
            "Mein Handyvertrag l√§uft 24 Monate. Ich hoffentlich auch noch! üèÉ",
            "Gesichtserkennung sagt 'Unbekanntes Gesicht'. Ich auch jeden Morgen! ü™û",
            "Hab Dark Mode entdeckt. Jetzt seh ich GAR nichts mehr! üåë",
            "Meine Bildschirmzeit ist h√∂her als mein Blutdruck. Beides schlecht! üìä",
            "Hab aus Versehen Siri aktiviert. Sie ist jetzt meine beste Freundin! üó£Ô∏è",
        ];

        const VETER_PAUSE = [
            "Pause? Gut, meine Blase auch! üöΩ",
            "Mein Arzt sagt ich soll mehr sitzen...",
            "Zeit f√ºr Kaffee Nr. 5! ‚òï",
            "Nickerchen-Zeit! *schnarch* üò¥",
            "Meine Frau sagt auch immer Pause!",
            "Herzschrittmacher macht auch Pause! üíì"
        ];

        const VETER_GAMEOVER = {
            amazing: ["WELTKLASSE! Extra Pudding! üçÆ", "FANTASTISCH! Besser als mein Hochzeitstanz 1979! üíÉ", "Ich ruf die Enkel an... wenn ich w√ºsste wie!"],
            great: ["Daf√ºr gibt's Werthers Original! üç¨", "Besser als meine Witze! ...Ok, das ist leicht.", "Erz√§hl ich im Wartezimmer! üè•"],
            good: ["Nicht wie Omas Suppe, aber gut!", "Solide! Wie mein Gebiss! ü¶∑", "Besser als mein Enkel beim Rasenm√§hen!"],
            ok: ["√úbung macht den Meister! √úbe seit 68 Jahren! üë¥", "Ich hab Zeit - bin Rentner!", "Wie mein Knie bei Regen! üåßÔ∏è"],
            bad: ["Meine blinde Katze spielt besser! üê±", "Teilnahme ist alles! Sag ich beim Bingo!", "Wenigstens versucht! *t√§tschelt*"]
        };

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        let running = false, paused = false;
        let score = 0, phones = 0, sims = 0, lives = 3;
        let pwrUsed = 0, maxCombo = 0, lastMilestone = 0;

        let hs = parseInt(localStorage.getItem('tkHS7')) || 0;
        let totalPh = parseInt(localStorage.getItem('tkPH7')) || 0;
        let maxLvl = parseInt(localStorage.getItem('tkLV7')) || 1;

        let speed = 4.5, frame = 0, lvl = 0;
        let combo = 0, comboT = 0, lastColl = 0;
        let inv = 0, power = null, pwrT = 0;

        let veterPopT = 0, veterSide = 'left', lastVeterJoke = 0;
        let usedJokes = [];

        const P = { x: 70, y: 0, w: 40, h: 60, vx: 0, vy: 0, ground: false, jump: false, face: 1, anim: 0, jumpT: 0, held: false };
        let plats = [], items = [], obs = [], parts = [], deco = [];
        let bgOff = 0;
        const keys = { left: false, right: false, jump: false };
        // ===== VETER ZEICHNUNG =====
        function drawVeter(id, happy = false) {
            const c = document.getElementById(id); if (!c) return;
            const x = c.getContext('2d'), cx = c.width / 2;
            x.clearRect(0, 0, c.width, c.height);
            x.fillStyle = '#9E8B76'; x.beginPath(); x.roundRect(cx - 26, 68, 52, 52, 8); x.fill();
            x.fillStyle = '#E8E4E0'; x.beginPath(); x.moveTo(cx - 9, 68); x.lineTo(cx + 9, 68); x.lineTo(cx + 7, 92); x.lineTo(cx - 7, 92); x.fill();
            x.fillStyle = MAGENTA; x.beginPath(); x.moveTo(cx, 72); x.lineTo(cx + 5, 95); x.lineTo(cx, 100); x.lineTo(cx - 5, 95); x.fill();
            x.fillStyle = '#4A4A52'; x.fillRect(cx - 18, 116, 14, 40); x.fillRect(cx + 4, 116, 14, 40);
            x.fillStyle = '#3D3028'; x.beginPath(); x.roundRect(cx - 21, 152, 20, 12, 4); x.fill(); x.beginPath(); x.roundRect(cx + 1, 152, 20, 12, 4); x.fill();
            x.fillStyle = '#9E8B76'; x.save(); x.translate(cx - 26, 76); x.rotate(happy ? -0.6 : -0.15); x.fillRect(-6, 0, 12, 38); x.restore();
            x.save(); x.translate(cx + 26, 76); x.rotate(happy ? 0.6 : 0.15); x.fillRect(-6, 0, 12, 38); x.restore();
            x.fillStyle = '#E8CDB5'; x.beginPath(); x.arc(cx - 36, happy ? 100 : 114, 7, 0, Math.PI * 2); x.fill(); x.beginPath(); x.arc(cx + 36, happy ? 100 : 114, 7, 0, Math.PI * 2); x.fill();
            if (!happy) { x.strokeStyle = '#5C4033'; x.lineWidth = 4; x.lineCap = 'round'; x.beginPath(); x.moveTo(cx + 40, 108); x.lineTo(cx + 36, 160); x.stroke(); x.beginPath(); x.arc(cx + 40, 106, 5, Math.PI, 0); x.stroke(); }
            x.fillStyle = '#E8CDB5'; x.fillRect(cx - 7, 53, 14, 18); x.beginPath(); x.ellipse(cx, 38, 20, 22, 0, 0, Math.PI * 2); x.fill();
            x.fillStyle = '#A8A8A8'; x.beginPath(); x.ellipse(cx - 17, 32, 7, 11, -0.2, 0, Math.PI * 2); x.fill(); x.beginPath(); x.ellipse(cx + 17, 32, 7, 11, 0.2, 0, Math.PI * 2); x.fill();
            x.fillStyle = '#F2DCC8'; x.beginPath(); x.ellipse(cx, 26, 13, 9, 0, Math.PI, 0); x.fill();
            x.fillStyle = '#E8CDB5'; x.beginPath(); x.ellipse(cx - 20, 40, 5, 7, 0, 0, Math.PI * 2); x.fill(); x.beginPath(); x.ellipse(cx + 20, 40, 5, 7, 0, 0, Math.PI * 2); x.fill();
            x.strokeStyle = '#4A4A52'; x.lineWidth = 2.5; x.beginPath(); x.roundRect(cx - 16, 32, 13, 11, 3); x.stroke(); x.beginPath(); x.roundRect(cx + 3, 32, 13, 11, 3); x.stroke();
            x.beginPath(); x.moveTo(cx - 3, 37); x.lineTo(cx + 3, 37); x.stroke();
            x.fillStyle = 'white'; x.beginPath(); x.ellipse(cx - 9, 38, 4, 4.5, 0, 0, Math.PI * 2); x.fill(); x.beginPath(); x.ellipse(cx + 9, 38, 4, 4.5, 0, 0, Math.PI * 2); x.fill();
            x.fillStyle = '#5588AA'; x.beginPath(); x.arc(cx - 9, 38, 2, 0, Math.PI * 2); x.fill(); x.beginPath(); x.arc(cx + 9, 38, 2, 0, Math.PI * 2); x.fill();
            x.fillStyle = '#909090'; x.beginPath(); x.ellipse(cx - 9, 29, 7, 3, 0, 0, Math.PI * 2); x.fill(); x.beginPath(); x.ellipse(cx + 9, 29, 7, 3, 0, 0, Math.PI * 2); x.fill();
            x.fillStyle = '#D4B8A0'; x.beginPath(); x.moveTo(cx, 36); x.quadraticCurveTo(cx + 7, 46, cx + 3, 50); x.lineTo(cx - 3, 50); x.quadraticCurveTo(cx - 7, 46, cx, 36); x.fill();
            x.strokeStyle = '#A08070'; x.lineWidth = 2;
            if (happy) { x.fillStyle = '#A08070'; x.beginPath(); x.arc(cx, 56, 6, 0, Math.PI); x.fill(); } 
            else { x.beginPath(); x.arc(cx, 60, 5, 1.1 * Math.PI, 1.9 * Math.PI); x.stroke(); }
            if (!happy) { x.fillStyle = CYAN; x.beginPath(); x.moveTo(cx + 26, 24); x.quadraticCurveTo(cx + 32, 32, cx + 26, 38); x.quadraticCurveTo(cx + 20, 32, cx + 26, 24); x.fill(); }
            if (happy) { x.fillStyle = 'rgba(255, 150, 150, 0.3)'; x.beginPath(); x.ellipse(cx - 14, 48, 6, 4, 0, 0, Math.PI * 2); x.fill(); x.beginPath(); x.ellipse(cx + 14, 48, 6, 4, 0, 0, Math.PI * 2); x.fill(); }
        }

        function showRandomJoke() {
            let available = VETER_JOKES.filter((_, i) => !usedJokes.includes(i));
            if (available.length === 0) { usedJokes = []; available = VETER_JOKES; }
            const idx = VETER_JOKES.indexOf(available[Math.floor(Math.random() * available.length)]);
            usedJokes.push(idx);
            document.getElementById('veter-pop-txt').textContent = VETER_JOKES[idx];
            const pop = document.getElementById('veter-pop');
            veterSide = veterSide === 'left' ? 'right' : 'left';
            pop.classList.remove('right', 'show');
            if (veterSide === 'right') pop.classList.add('right');
            setTimeout(() => pop.classList.add('show'), 50);
            veterPopT = 280;
            lastVeterJoke = frame;
        }

        function hideVeterPopup() { document.getElementById('veter-pop').classList.remove('show'); }

        let scene = 1;
        function nextScene() {
            document.getElementById('s' + scene).classList.remove('active');
            scene++;
            const el = document.getElementById('s' + scene);
            if (el) { el.classList.add('active'); setTimeout(() => { if (scene === 2) drawVeter('vc2', false); if (scene === 4) drawVeter('vc3', true); }, 50); }
        }
        function startFromIntro() { show('menu'); localStorage.setItem('tkIntro7', '1'); }
        function showIntro() { scene = 1; document.querySelectorAll('.intro-scene').forEach(s => s.classList.remove('active')); document.getElementById('s1').classList.add('active'); show('intro'); setTimeout(() => drawVeter('vc1', false), 50); }

        function show(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); document.getElementById(id)?.classList.add('active'); }
        function showOv(id) { document.getElementById(id)?.classList.add('active'); }
        function hideOv(id) { document.getElementById(id)?.classList.remove('active'); }

        function init() { resize(); updMenu(); events(); if (!localStorage.getItem('tkIntro7')) { setTimeout(() => drawVeter('vc1', false), 100); } else { show('menu'); } }
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function updMenu() { document.getElementById('m-hs').textContent = hs; document.getElementById('m-ph').textContent = totalPh; document.getElementById('m-lvl').textContent = maxLvl; }

        function updSound() {
            [document.getElementById('snd-menu'), document.getElementById('snd-game')].forEach(b => {
                if (!b) return;
                if (sfx.muted) { b.classList.add('muted'); b.querySelector('.on').style.display = 'none'; b.querySelector('.off').style.display = 'block'; }
                else { b.classList.remove('muted'); b.querySelector('.on').style.display = 'block'; b.querySelector('.off').style.display = 'none'; }
            });
        }

        function events() {
            window.addEventListener('resize', resize);
            document.getElementById('snd-menu').onclick = () => { sfx.init(); sfx.toggle(); updSound(); };
            document.getElementById('snd-game').onclick = () => { sfx.toggle(); updSound(); };
            document.getElementById('btn-play').onclick = startGame;
            document.getElementById('btn-story').onclick = showIntro;
            document.getElementById('btn-help').onclick = showHelp;
            document.getElementById('btn-pause').onclick = togglePause;
            document.getElementById('btn-resume').onclick = togglePause;
            document.getElementById('btn-quit').onclick = toMenu;
            document.getElementById('btn-retry').onclick = startGame;
            document.getElementById('btn-menu').onclick = toMenu;

            // MULTITOUCH mit Pointer Events!
            const buttons = { 'c-left': 'left', 'c-right': 'right', 'c-jump': 'jump' };
            const activePointers = {};

            Object.entries(buttons).forEach(([id, key]) => {
                const el = document.getElementById(id);
                
                el.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    activePointers[e.pointerId] = key;
                    keys[key] = true;
                    el.classList.add('active');
                    el.setPointerCapture(e.pointerId);
                });

                el.addEventListener('pointerup', (e) => {
                    e.preventDefault();
                    if (activePointers[e.pointerId] === key) {
                        delete activePointers[e.pointerId];
                        keys[key] = false;
                        el.classList.remove('active');
                    }
                });

                el.addEventListener('pointercancel', (e) => {
                    e.preventDefault();
                    if (activePointers[e.pointerId] === key) {
                        delete activePointers[e.pointerId];
                        keys[key] = false;
                        el.classList.remove('active');
                    }
                });

                el.addEventListener('pointerleave', (e) => {
                    if (activePointers[e.pointerId] === key) {
                        delete activePointers[e.pointerId];
                        keys[key] = false;
                        el.classList.remove('active');
                    }
                });
            });

            document.addEventListener('keydown', e => {
                if (['ArrowLeft', 'a', 'A'].includes(e.key)) keys.left = true;
                if (['ArrowRight', 'd', 'D'].includes(e.key)) keys.right = true;
                if (['ArrowUp', 'w', 'W', ' '].includes(e.key)) keys.jump = true;
                if (['Escape', 'p', 'P'].includes(e.key)) togglePause();
            });
            document.addEventListener('keyup', e => {
                if (['ArrowLeft', 'a', 'A'].includes(e.key)) keys.left = false;
                if (['ArrowRight', 'd', 'D'].includes(e.key)) keys.right = false;
                if (['ArrowUp', 'w', 'W', ' '].includes(e.key)) keys.jump = false;
            });
        }

        function showHelp() {
            alert(`üì± TELEKOM SIMULATOR - TMC SAUERLAND

üéØ Hilf Veter Pogel (68) seine Bestellung zu retten!

üéÆ STEUERUNG:
‚Üê ‚Üí Bewegen | ‚Üë Springen (halten = h√∂her)

üì± Handy = 100 Punkte | üí≥ SIM = 50 Punkte
üî• Combos = Bonus! | ‚ù§Ô∏è 1000 Punkte = Extra Leben

‚ö° POWERUPS:
üß≤ Magnet | üí® Speed | üõ°Ô∏è Shield | ‚≠ê Doppelt

üë¥ Veter erz√§hlt zwischendurch Flachwitze! üòÇ`);
        }

        function notif(txt, type = 'combo') {
            const el = document.getElementById('notif');
            el.textContent = txt;
            el.className = 'notif ' + type + ' show';
            setTimeout(() => el.classList.remove('show'), 1400);
        }
        function startGame() {
            sfx.init(); sfx.resume(); show('game'); hideOv('ov-over'); hideVeterPopup();
            score = 0; phones = 0; sims = 0; lives = 3; pwrUsed = 0; maxCombo = 0; lastMilestone = 0;
            frame = 0; lvl = 0; combo = 0; comboT = 0; inv = 0; power = null; pwrT = 0;
            veterPopT = 0; lastVeterJoke = -200; usedJokes = [];
            speed = LEVELS[0].speed;
            P.x = 70; P.y = canvas.height - 180; P.vx = 0; P.vy = 0; P.ground = false; P.jump = false; P.face = 1; P.anim = 0; P.jumpT = 0; P.held = false;
            plats = []; items = []; obs = []; parts = []; deco = []; bgOff = 0;
            genWorld(); updLvl(); updHUD();
            document.getElementById('pwr-bar').classList.remove('active');
            running = true; paused = false; sfx.music();
            requestAnimationFrame(loop);
        }

        function genWorld() {
            plats.push({ x: -50, y: canvas.height - 65, w: canvas.width + 400, h: 65, type: 'g' });
            for (let i = 0; i < 7; i++) { const px = 180 + i * 160, py = canvas.height - 140 - Math.random() * 90; plats.push({ x: px, y: py, w: 90 + Math.random() * 50, h: 14, type: 'f' }); if (Math.random() > 0.2) spawnItem(px + 45, py - 40); }
            for (let i = 0; i < 10; i++) deco.push({ x: Math.random() * canvas.width * 2, y: 30 + Math.random() * 100, t: 'c', s: 20 + Math.random() * 30, sp: 0.15 + Math.random() * 0.3 });
            for (let i = 0; i < 6; i++) deco.push({ x: i * 180 + Math.random() * 80, y: canvas.height - 65, t: 'b', w: 35 + Math.random() * 50, h: 70 + Math.random() * 120 });
        }

        function spawnItem(x, y) {
            const r = Math.random();
            let t = r < 0.03 && lvl <= 1 ? 'heart' : r < 0.40 ? 'phone' : r < 0.75 ? 'sim' : 'pwr';
            items.push({ x, y, t, a: Math.random() * 6.28, b: Math.random() * 6.28 });
        }

        function togglePause() {
            if (!running) return;
            paused = !paused;
            if (paused) { sfx.stop(); hideVeterPopup(); document.getElementById('pause-tip').textContent = VETER_PAUSE[Math.floor(Math.random() * VETER_PAUSE.length)]; showOv('ov-pause'); }
            else { hideOv('ov-pause'); sfx.music(); requestAnimationFrame(loop); }
        }

        function toMenu() { running = false; paused = false; sfx.stop(); hideVeterPopup(); hideOv('ov-pause'); hideOv('ov-over'); show('menu'); updMenu(); }

        function gameOver() {
            running = false; sfx.stop(); sfx.die(); hideVeterPopup();
            totalPh += phones; localStorage.setItem('tkPH7', totalPh);
            if (lvl + 1 > maxLvl) { maxLvl = lvl + 1; localStorage.setItem('tkLV7', maxLvl); }
            const isHS = score > hs; if (isHS) { hs = score; localStorage.setItem('tkHS7', hs); }
            document.getElementById('f-score').textContent = score;
            document.getElementById('f-phones').textContent = phones;
            document.getElementById('f-sims').textContent = sims;
            document.getElementById('f-pwr').textContent = pwrUsed;
            document.getElementById('f-combo').textContent = maxCombo;
            const ach = document.getElementById('achieve');
            if (isHS) { document.getElementById('ach-icon').textContent = 'üèÜ'; document.getElementById('ach-txt').textContent = 'Neuer Highscore!'; ach.classList.add('show'); }
            else if (lvl >= 5) { document.getElementById('ach-icon').textContent = 'üåü'; document.getElementById('ach-txt').textContent = '5G Endzone!'; ach.classList.add('show'); }
            else { ach.classList.remove('show'); }
            let c = score >= 5000 ? VETER_GAMEOVER.amazing : score >= 3000 ? VETER_GAMEOVER.great : score >= 1500 ? VETER_GAMEOVER.good : score >= 500 ? VETER_GAMEOVER.ok : VETER_GAMEOVER.bad;
            document.getElementById('veter-say').textContent = c[Math.floor(Math.random() * c.length)];
            showOv('ov-over');
        }

        function updLvl() { document.getElementById('lvl-badge').textContent = `Level ${lvl + 1} - ${LEVELS[lvl].name}`; }
        function updHUD() { document.getElementById('h-score').textContent = score; document.getElementById('h-phones').textContent = phones; document.getElementById('h-sims').textContent = sims; document.getElementById('h-lives').textContent = lives; }

        function loop() { if (!running || paused) return; update(); render(); requestAnimationFrame(loop); }

        function update() {
            frame++;
            const L = LEVELS[lvl];

            if (veterPopT > 0) { veterPopT--; if (veterPopT <= 0) hideVeterPopup(); }

            // Level up
            const newLvl = LEVELS.findIndex(l => score < l.target);
            if (newLvl !== -1 && newLvl !== lvl) { lvl = newLvl; speed = LEVELS[lvl].speed; updLvl(); notif(`‚¨ÜÔ∏è ${LEVELS[lvl].name}!`, 'lvl'); sfx.lvlup(); if (lvl >= 4) { lives++; setTimeout(() => notif('‚ù§Ô∏è Bonus!', 'power'), 1500); } }

            if (score >= lastMilestone + 1000) { lastMilestone = Math.floor(score / 1000) * 1000; lives++; notif('‚ù§Ô∏è +1!', 'power'); sfx.life(); }
            if (comboT > 0) { comboT--; if (comboT <= 0) { if (combo > maxCombo) maxCombo = combo; combo = 0; } }
            if (inv > 0) inv--;
            if (power) { pwrT--; document.getElementById('pwr-time').textContent = Math.ceil(pwrT / 60) + 's'; if (pwrT <= 0) { power = null; document.getElementById('pwr-bar').classList.remove('active'); } }

            // Player
            const spd = power === 'speed' ? 6.5 : 5;
            if (keys.left) { P.vx = -spd; P.face = -1; } else if (keys.right) { P.vx = spd; P.face = 1; } else P.vx *= 0.82;
            if (keys.jump && P.ground && !P.held) { P.vy = -13; P.ground = false; P.jump = true; P.held = true; P.jumpT = 10; sfx.jump(); mkParts(P.x + P.w/2, P.y + P.h, MAGENTA, 5); }
            if (keys.jump && P.jumpT > 0 && P.vy < 0) { P.vy -= 0.45; P.jumpT--; }
            if (!keys.jump) { P.held = false; P.jumpT = 0; }
            P.vy += L.grav; P.y += P.vy; P.x += P.vx;
            P.x = Math.max(5, Math.min(canvas.width - P.w - 5, P.x));
            if (Math.abs(P.vx) > 0.4) P.anim += 0.22;
            P.ground = false;
            for (const p of plats) { if (platColl(P, p)) { P.y = p.y - P.h; P.vy = 0; P.ground = true; P.jump = false; } }
            if (P.y > canvas.height + 50) { hurt(); return; }

            // World scroll
            bgOff += speed * 0.5;
            for (const p of plats) p.x -= speed;
            for (const o of obs) o.x -= speed;
            for (const i of items) i.x -= speed;
            for (const d of deco) d.x -= (d.t === 'c' ? d.sp : speed * 0.25);
            plats = plats.filter(p => p.x + p.w > -50);
            obs = obs.filter(o => o.x + o.w > -50);
            items = items.filter(i => i.x > -50);
            deco = deco.filter(d => d.x + (d.s || d.w || 50) > -50);
            while (deco.filter(d => d.t === 'c').length < 8) deco.push({ x: canvas.width + Math.random() * 150, y: 30 + Math.random() * 100, t: 'c', s: 20 + Math.random() * 30, sp: 0.15 + Math.random() * 0.3 });

            // Generate platforms
            const rightmost = plats.reduce((m, p) => Math.max(m, p.x + p.w), 0);
            while (rightmost < canvas.width + 500) {
                const last = plats[plats.length - 1], gap = (45 + Math.random() * 50) * L.gap, nx = last.x + last.w + gap;
                if (Math.random() > 0.45 || plats.filter(p => p.type === 'g').slice(-3).length < 1) {
                    const gw = 160 + Math.random() * 200;
                    plats.push({ x: nx, y: canvas.height - 65, w: gw, h: 65, type: 'g' });
                    if (Math.random() < L.obs && gw > 140) obs.push({ x: nx + 50 + Math.random() * (gw - 100), y: canvas.height - 108, w: 26, h: 43 });
                } else {
                    const minY = Math.max(canvas.height - 260, last.y - 70), maxY = Math.min(canvas.height - 130, last.y + 50);
                    plats.push({ x: nx, y: minY + Math.random() * (maxY - minY), w: 80 + Math.random() * 55, h: 14, type: 'f' });
                }
                const np = plats[plats.length - 1];
                if (Math.random() > 0.28) spawnItem(np.x + np.w/2, np.y - 42);
                if (Math.random() > 0.7) deco.push({ x: nx, y: canvas.height - 65, t: 'b', w: 35 + Math.random() * 50, h: 70 + Math.random() * 120 });
                break;
            }

            // Items
            for (const i of items) {
                i.a += 0.035;
                if (power === 'magnet') { const dx = (P.x + P.w/2) - i.x, dy = (P.y + P.h/2) - i.y, d = Math.sqrt(dx*dx + dy*dy); if (d < 160) { i.x += dx * 0.1; i.y += dy * 0.1; } }
                if (itemColl(P, i)) { collect(i); items.splice(items.indexOf(i), 1); }
            }

            // Obstacles
            if (inv <= 0) {
                for (const o of obs) {
                    if (boxColl(P, o)) {
                        if (power === 'shield') { power = null; document.getElementById('pwr-bar').classList.remove('active'); notif('üõ°Ô∏è Schutz!', 'warn'); mkParts(o.x + o.w/2, o.y + o.h/2, CYAN, 12); obs.splice(obs.indexOf(o), 1); inv = 50; }
                        else { hurt(); return; }
                    }
                }
            }

            // Particles
            for (const p of parts) { p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.l--; }
            parts = parts.filter(p => p.l > 0);

            score = Math.floor(frame / 5) + phones * 100 + sims * 50;
            if (power === 'double') score += Math.floor(frame / 8);
            updHUD();

            // FLACHWITZ ALLE ~6 SEKUNDEN!
            if (frame - lastVeterJoke > 360) showRandomJoke();
        }

        function hurt() {
            lives--; sfx.hurt(); mkParts(P.x + P.w/2, P.y + P.h/2, MAGENTA_LIGHT, 18);
            if (lives <= 0) gameOver();
            else { inv = 100; P.y = canvas.height - 180; P.vy = 0; notif('üíî Autsch!', 'warn'); }
        }

        function collect(i) {
            const now = frame;
            if (now - lastColl < 90) { combo++; comboT = 130; if (combo >= 3) { score += combo * 18; if (combo % 5 === 0) { notif(`üî• x${combo}!`, 'combo'); sfx.combo(); } } }
            else { combo = 1; comboT = 130; }
            lastColl = now;
            const mult = power === 'double' ? 2 : 1;
            if (i.t === 'phone') { phones++; score += 100 * mult; sfx.phone(); mkParts(i.x, i.y, CYAN, 9); }
            else if (i.t === 'sim') { sims++; score += 50 * mult; sfx.sim(); mkParts(i.x, i.y, GOLD, 7); }
            else if (i.t === 'pwr') { pwrUsed++; const t = ['magnet', 'speed', 'shield', 'double']; power = t[Math.floor(Math.random() * t.length)]; pwrT = 330; sfx.power(); mkParts(i.x, i.y, GREEN, 10); const ic = { magnet: 'üß≤', speed: 'üí®', shield: 'üõ°Ô∏è', double: '‚≠ê' }; document.getElementById('pwr-icon').textContent = ic[power]; document.getElementById('pwr-bar').classList.add('active'); notif(ic[power] + ' Power!', 'power'); }
            else if (i.t === 'heart') { lives++; sfx.life(); mkParts(i.x, i.y, RED, 10); notif('‚ù§Ô∏è +1!', 'power'); }
        }

        function platColl(p, pl) { return p.vy >= 0 && p.x + p.w > pl.x + 4 && p.x < pl.x + pl.w - 4 && p.y + p.h >= pl.y && p.y + p.h <= pl.y + pl.h + 10; }
        function boxColl(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
        function itemColl(p, i) { const px = p.x + p.w/2, py = p.y + p.h/2, dx = px - i.x, dy = py - i.y; return Math.sqrt(dx*dx + dy*dy) < 38; }
        function mkParts(x, y, c, n) { for (let i = 0; i < n; i++) parts.push({ x, y, vx: (Math.random()-0.5)*7, vy: (Math.random()-0.5)*7 - 2, c, l: 22 + Math.random()*12 }); }
        // ===== RENDERING =====
        function render() {
            const L = LEVELS[lvl];

            ctx.fillStyle = L.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = 'rgba(226, 0, 116, 0.035)';
            ctx.lineWidth = 1;
            const g = 45, ox = bgOff % g;
            for (let x = -ox; x < canvas.width; x += g) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for (let y = 0; y < canvas.height; y += g) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }

            for (const d of deco) {
                if (d.t === 'b') {
                    ctx.fillStyle = 'rgba(25, 20, 35, 0.5)';
                    ctx.fillRect(d.x, d.y - d.h, d.w, d.h);
                    ctx.fillStyle = 'rgba(226, 0, 116, 0.12)';
                    for (let wy = d.y - d.h + 12; wy < d.y - 8; wy += 22) {
                        for (let wx = d.x + 6; wx < d.x + d.w - 6; wx += 15) {
                            if (Math.random() > 0.4) ctx.fillRect(wx, wy, 8, 13);
                        }
                    }
                }
            }

            for (const d of deco) {
                if (d.t === 'c') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.025)';
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, d.s, 0, Math.PI * 2);
                    ctx.arc(d.x + d.s * 0.5, d.y - d.s * 0.2, d.s * 0.6, 0, Math.PI * 2);
                    ctx.arc(d.x + d.s * 0.9, d.y, d.s * 0.7, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            const hg = ctx.createLinearGradient(0, canvas.height - 160, 0, canvas.height);
            hg.addColorStop(0, 'transparent');
            hg.addColorStop(1, 'rgba(226, 0, 116, 0.1)');
            ctx.fillStyle = hg;
            ctx.fillRect(0, canvas.height - 160, canvas.width, 160);

            for (const p of plats) drawPlat(p, L.color);
            for (const o of obs) drawObs(o);
            for (const i of items) drawItem(i);

            for (const p of parts) {
                ctx.globalAlpha = p.l / 30;
                ctx.fillStyle = p.c;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            drawTMC();
        }

        function drawPlat(p, col) {
            if (p.type === 'g') {
                const g = ctx.createLinearGradient(p.x, p.y, p.x, p.y + p.h);
                g.addColorStop(0, col);
                g.addColorStop(1, shade(col, -25));
                ctx.fillStyle = g;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.fillStyle = shade(col, 18);
                ctx.fillRect(p.x, p.y, p.w, 3);
                ctx.strokeStyle = 'rgba(255,255,255,0.06)';
                for (let x = p.x; x < p.x + p.w; x += 35) { ctx.beginPath(); ctx.moveTo(x, p.y); ctx.lineTo(x, p.y + p.h); ctx.stroke(); }
            } else {
                ctx.fillStyle = '#181820';
                rr(ctx, p.x, p.y, p.w, p.h, 5); ctx.fill();
                ctx.shadowColor = MAGENTA; ctx.shadowBlur = 8;
                ctx.fillStyle = MAGENTA;
                ctx.fillRect(p.x + 2, p.y, p.w - 4, 2.5);
                ctx.shadowBlur = 0;
            }
        }

        function drawObs(o) {
            ctx.save();
            ctx.translate(o.x + o.w/2, o.y + o.h/2);
            ctx.rotate(Math.sin(frame * 0.08) * 0.12);

            ctx.fillStyle = '#282830';
            rr(ctx, -o.w/2, -o.h/2 + 4, o.w, o.h - 8, 4); ctx.fill();

            ctx.fillStyle = RED;
            ctx.beginPath(); ctx.arc(-5, -4, 3.5, 0, Math.PI * 2); ctx.arc(5, -4, 3.5, 0, Math.PI * 2); ctx.fill();

            ctx.strokeStyle = RED; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(-10, -10); ctx.lineTo(-2, -7); ctx.moveTo(10, -10); ctx.lineTo(2, -7); ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 7, 5, 0.1 * Math.PI, 0.9 * Math.PI); ctx.stroke();

            ctx.strokeStyle = '#444'; ctx.lineWidth = 2.5;
            ctx.beginPath(); ctx.moveTo(-7, -o.h/2 + 4); ctx.lineTo(-9, -o.h/2 - 7); ctx.moveTo(7, -o.h/2 + 4); ctx.lineTo(9, -o.h/2 - 7); ctx.stroke();
            ctx.fillStyle = RED; ctx.shadowColor = RED; ctx.shadowBlur = 6;
            ctx.beginPath(); ctx.arc(-9, -o.h/2 - 9, 2.5, 0, Math.PI * 2); ctx.arc(9, -o.h/2 - 9, 2.5, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;

            ctx.fillStyle = GOLD; ctx.font = 'bold 8px Outfit'; ctx.textAlign = 'center';
            ctx.fillText('‚ö†Ô∏è', 0, 20);

            ctx.restore();
        }

        function drawItem(i) {
            const bob = Math.sin(frame * 0.055 + i.b) * 5;
            ctx.save();
            ctx.translate(i.x, i.y + bob);

            if (i.t === 'phone') {
                ctx.shadowColor = CYAN; ctx.shadowBlur = 14;
                ctx.fillStyle = '#1a1a28'; rr(ctx, -12, -20, 24, 40, 4); ctx.fill();
                ctx.fillStyle = CYAN; ctx.globalAlpha = 0.8 + Math.sin(frame * 0.08) * 0.2;
                ctx.fillRect(-9, -16, 18, 29); ctx.globalAlpha = 1;
                ctx.fillStyle = MAGENTA; ctx.font = 'bold 12px Outfit'; ctx.textAlign = 'center';
                ctx.fillText('T', 0, 2);
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI * 2); ctx.fill();
            } else if (i.t === 'sim') {
                ctx.shadowColor = GOLD; ctx.shadowBlur = 14;
                ctx.rotate(i.a * 0.25);
                ctx.fillStyle = GOLD;
                ctx.beginPath(); ctx.moveTo(-10, -14); ctx.lineTo(10, -14); ctx.lineTo(10, 8); ctx.lineTo(3, 14); ctx.lineTo(-10, 14); ctx.closePath(); ctx.fill();
                ctx.fillStyle = '#DAA520'; ctx.fillRect(-5, -5, 10, 10);
                ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 1.2;
                ctx.beginPath(); ctx.moveTo(-5, 0); ctx.lineTo(5, 0); ctx.moveTo(0, -5); ctx.lineTo(0, 5); ctx.stroke();
                ctx.fillStyle = MAGENTA; ctx.font = 'bold 6px Outfit'; ctx.fillText('T', 0, -9);
            } else if (i.t === 'pwr') {
                ctx.shadowColor = GREEN; ctx.shadowBlur = 18;
                ctx.rotate(i.a);
                ctx.fillStyle = GREEN; rr(ctx, -13, -13, 26, 26, 5); ctx.fill();
                ctx.fillStyle = '#003320'; ctx.font = 'bold 16px Outfit'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('‚ö°', 0, 0);
            } else if (i.t === 'heart') {
                ctx.shadowColor = RED; ctx.shadowBlur = 14;
                ctx.fillStyle = RED;
                ctx.beginPath();
                ctx.moveTo(0, 7);
                ctx.bezierCurveTo(-11, -3, -11, -13, 0, -13);
                ctx.bezierCurveTo(11, -13, 11, -3, 0, 7);
                ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.35)';
                ctx.beginPath(); ctx.arc(-3, -5, 2.5, 0, Math.PI * 2); ctx.fill();
            }

            ctx.shadowBlur = 0;
            ctx.restore();
        }

        function drawTMC() {
            ctx.save();
            ctx.translate(P.x + P.w/2, P.y + P.h/2);

            if (inv > 0 && Math.floor(inv / 4) % 2 === 0) ctx.globalAlpha = 0.45;
            if (P.face === -1) ctx.scale(-1, 1);

            const j = P.jump, r = Math.abs(P.vx) > 0.4;
            const la = r ? Math.sin(P.anim) * 7 : 0;

            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.ellipse(0, P.h/2 - 2, 14, 4, 0, 0, Math.PI * 2); ctx.fill();

            ctx.fillStyle = '#1a1a28';
            ctx.save(); ctx.translate(-6, 9); if (j) ctx.rotate(0.22);
            ctx.fillRect(-4, 0, 8, 18 + (j ? -3 : la));
            ctx.fillStyle = '#111'; rr(ctx, -5, 16 + (j ? -3 : la), 10, 6, 2.5); ctx.fill();
            ctx.restore();
            
            ctx.save(); ctx.translate(6, 9); if (j) ctx.rotate(-0.22);
            ctx.fillStyle = '#1a1a28';
            ctx.fillRect(-4, 0, 8, 18 + (j ? -3 : -la));
            ctx.fillStyle = '#111'; rr(ctx, -5, 16 + (j ? -3 : -la), 10, 6, 2.5); ctx.fill();
            ctx.restore();

            ctx.shadowColor = MAGENTA; ctx.shadowBlur = 10;
            const bg = ctx.createLinearGradient(-14, -20, 14, 10);
            bg.addColorStop(0, MAGENTA_LIGHT); bg.addColorStop(0.5, MAGENTA); bg.addColorStop(1, MAGENTA_DARK);
            ctx.fillStyle = bg; rr(ctx, -14, -20, 28, 33, 6); ctx.fill();
            ctx.fillStyle = MAGENTA_DARK;
            ctx.beginPath(); ctx.moveTo(-8, -20); ctx.lineTo(0, -14); ctx.lineTo(8, -20); ctx.lineTo(8, -17); ctx.lineTo(0, -11); ctx.lineTo(-8, -17); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font = 'bold 12px Outfit'; ctx.textAlign = 'center'; ctx.fillText('T', 0, -1);
            ctx.fillStyle = 'white'; rr(ctx, -9, 3, 18, 7, 2); ctx.fill();
            ctx.fillStyle = MAGENTA; ctx.font = 'bold 4px Outfit'; ctx.fillText('TMC', 0, 8);
            ctx.shadowBlur = 0;

            ctx.fillStyle = '#E8C4A0';
            ctx.save(); ctx.translate(-14, -15); ctx.rotate(j ? -0.6 : (r ? Math.sin(P.anim + 1) * 0.3 : 0.08));
            ctx.fillStyle = MAGENTA; ctx.fillRect(-3, 0, 8, 10);
            ctx.fillStyle = '#E8C4A0'; ctx.fillRect(-2, 9, 6, 11);
            ctx.beginPath(); ctx.arc(1, 22, 4, 0, Math.PI * 2); ctx.fill();
            ctx.restore();

            ctx.save(); ctx.translate(14, -15); ctx.rotate(j ? 0.6 : (r ? Math.sin(P.anim) * 0.3 : -0.08));
            ctx.fillStyle = MAGENTA; ctx.fillRect(-5, 0, 8, 10);
            ctx.fillStyle = '#E8C4A0'; ctx.fillRect(-4, 9, 6, 11);
            ctx.beginPath(); ctx.arc(-1, 22, 4, 0, Math.PI * 2); ctx.fill();
            if (!j) { ctx.fillStyle = '#1a1a28'; rr(ctx, -4, 17, 8, 12, 2); ctx.fill(); ctx.fillStyle = CYAN; ctx.fillRect(-3, 19, 6, 8); }
            ctx.restore();

            ctx.fillStyle = '#E8C4A0';
            ctx.fillRect(-5, -26, 10, 7);
            ctx.beginPath(); ctx.ellipse(0, -37, 13, 14, 0, 0, Math.PI * 2); ctx.fill();

            ctx.fillStyle = '#2a1810';
            ctx.beginPath(); ctx.ellipse(0, -46, 10, 7, 0, Math.PI, 0); ctx.fill();
            ctx.fillRect(-12, -46, 24, 6);
            ctx.fillRect(-13, -44, 3, 9); ctx.fillRect(10, -44, 3, 9);

            ctx.fillStyle = '#E8C4A0';
            ctx.beginPath(); ctx.ellipse(-13, -37, 3.5, 4.5, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(13, -37, 3.5, 4.5, 0, 0, Math.PI * 2); ctx.fill();

            ctx.strokeStyle = '#333'; ctx.lineWidth = 2.2;
            ctx.beginPath(); ctx.arc(0, -43, 14, Math.PI * 0.72, Math.PI * 0.28); ctx.stroke();
            ctx.fillStyle = MAGENTA;
            ctx.beginPath(); ctx.ellipse(-13, -37, 4.5, 6, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(13, -37, 4.5, 6, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#333';
            ctx.beginPath(); ctx.moveTo(-13, -33); ctx.quadraticCurveTo(-16, -26, -9, -24); ctx.lineTo(-7, -26); ctx.quadraticCurveTo(-12, -28, -11, -33); ctx.fill();
            ctx.fillStyle = MAGENTA; ctx.beginPath(); ctx.arc(-8, -24, 2.2, 0, Math.PI * 2); ctx.fill();

            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.ellipse(-4.5, -37, 4, 5, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(4.5, -37, 4, 5, 0, 0, Math.PI * 2); ctx.fill();
            const px = P.face * 1;
            ctx.fillStyle = '#2a1810';
            ctx.beginPath(); ctx.arc(-4.5 + px, -37, 2, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(4.5 + px, -37, 2, 0, Math.PI * 2); ctx.fill();

            ctx.strokeStyle = '#2a1810'; ctx.lineWidth = 1.6;
            ctx.beginPath(); ctx.moveTo(-8, -44); ctx.lineTo(-2, -42); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(8, -44); ctx.lineTo(2, -42); ctx.stroke();

            ctx.strokeStyle = '#c47a5a'; ctx.lineWidth = 1.6;
            if (j) {
                ctx.fillStyle = '#c47a5a'; ctx.beginPath(); ctx.arc(0, -30, 3.5, 0, Math.PI); ctx.fill();
            } else {
                ctx.beginPath(); ctx.arc(0, -31, 4.5, 0.1 * Math.PI, 0.9 * Math.PI); ctx.stroke();
            }

            ctx.fillStyle = '#D4A574';
            ctx.beginPath(); ctx.moveTo(0, -39); ctx.lineTo(2, -33); ctx.lineTo(-2, -33); ctx.fill();

            if (power) {
                ctx.globalAlpha = 0.22 + Math.sin(frame * 0.12) * 0.12;
                const ac = power === 'magnet' ? '#FF00FF' : power === 'speed' ? '#FFFF00' : power === 'shield' ? '#00FFFF' : GOLD;
                ctx.strokeStyle = ac; ctx.shadowColor = ac; ctx.shadowBlur = 22; ctx.lineWidth = 2.5;
                ctx.beginPath(); ctx.ellipse(0, -6, 20, 34, 0, 0, Math.PI * 2); ctx.stroke();
                ctx.shadowBlur = 0;
            }

            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function rr(c, x, y, w, h, r) {
            c.beginPath();
            c.moveTo(x + r, y);
            c.arcTo(x + w, y, x + w, y + h, r);
            c.arcTo(x + w, y + h, x, y + h, r);
            c.arcTo(x, y + h, x, y, r);
            c.arcTo(x, y, x + w, y, r);
            c.closePath();
        }

        function shade(c, p) {
            const n = parseInt(c.replace('#', ''), 16);
            const a = Math.round(2.55 * p);
            const R = Math.max(0, Math.min(255, (n >> 16) + a));
            const G = Math.max(0, Math.min(255, ((n >> 8) & 0xFF) + a));
            const B = Math.max(0, Math.min(255, (n & 0xFF) + a));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        init();
    </script>
</body>
</html>
